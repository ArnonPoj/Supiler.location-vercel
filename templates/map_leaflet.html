<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏ö‡∏ö Folium + Leaflet</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>


  <style>
    html, body { height: 100%; margin: 0; font-family: 'Roboto', sans-serif; }
    #mapid { height: 100%; }
    

    #exportBtn {
      position: fixed; top: 20px; right: 20px; z-index: 9999;
      padding: 10px 15px; background-color: #4CAF50;
      color: white; border: none; border-radius: 8px;
      cursor: pointer; font-family: 'Roboto', sans-serif;
    }
    #exportBtn:hover { background-color: #45a049; }

    #importBtn {
      position: fixed; top: 20px; right: 140px; z-index: 9999;
      padding: 10px 15px; background-color: #2196F3;
      color: white; border: none; border-radius: 8px;
      cursor: pointer; font-family: 'Roboto', sans-serif;
    }
    #importBtn:hover { background-color: #1976D2; }

    #floatBtn {
      position: fixed; bottom: 20px; right: 20px;
      width: 48px; height: 48px; border-radius: 24px;
      font-size: 28px; background: #007bff;
      color: white; border: none; cursor: pointer;
      z-index: 999; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    #transportPopupBR {
      display: none;
      position: fixed;
      right: 20px;
      bottom: 140px;   /* ‡∏•‡∏≠‡∏¢‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏° + */
      width: 320px;
      max-height: 70vh;
      overflow-y: auto;
      background: #fff;
      padding: 12px;
      border-radius: 10px;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0,0,0,.25);
    }

    
    #popupForm {
      display: none; position: fixed; bottom: 80px; right: 20px;
      background: white; padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      border-radius: 8px; width: 280px; z-index: 1000;
    }

    #popupForm input, #popupForm textarea, #popupForm button {
      width: 100%; margin-bottom: 8px; padding: 8px;
      font-size: 14px; font-family: 'Roboto', sans-serif;
      box-sizing: border-box;
    }

    #popupForm textarea { resize: vertical; }
    #popupForm button#cancelPopupBtn { background: #ccc; }

    #searchBox {
      position: fixed; top: 20px; left: 20px; z-index: 9999;
      width: 300px; padding: 8px 12px; font-size: 14px;
      border-radius: 8px; border: 1px solid #ccc;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      font-family: 'Roboto', sans-serif;
    }

    .leaflet-tooltip.marker-label {
      background: rgba(255,255,255,0.9); color: #333;
      border-radius: 4px; padding: 2px 6px; font-size: 13px;
      font-weight: bold; border: 1px solid #ccc;
      font-family: 'Roboto', sans-serif;
    }

    .leaflet-popup-content {
      font-family: 'Roboto', sans-serif;
    }

    #toast {
      position: fixed; bottom: 20px; right: 20px;
      background-color: rgba(51,51,51,0.95); color: #fff;
      padding: 10px 18px; border-radius: 8px;
      display: none; z-index: 99999; font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    #transportBtn {
  position: fixed;
  bottom: 140px;      /* ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ + */
  right: 20px;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  font-size: 22px;
  background: #ff9800;
  color: white;
  border: none;
  cursor: pointer;
  z-index: 10001;     /* ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ map */
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
  </style>

  <style>
.popup {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 10000;
}
.popup-card {
  background: #fff;
  width: 420px;
  max-height: 90vh;
  overflow-y: auto;
  margin: 5vh auto;
  padding: 16px;
  border-radius: 10px;
}
.transport-type label {
  display: block;
  margin-bottom: 6px;
  cursor: pointer;
}
.section {
  margin-bottom: 14px;
}
.section h4 {
  margin: 8px 0;
}
input, select {
  width: 100%;
  margin-bottom: 6px;
  padding: 6px;
}
.popup-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}
.cancel {
  background: #ccc;
}
.hint {
  color: #666;
  font-size: 12px;
}
ul {
  padding-left: 18px;
}
.search-select {
  position: relative;
  margin-bottom: 6px;
}

.dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: #fff;
  border: 1px solid #ccc;
  max-height: 160px;
  overflow-y: auto;
  z-index: 20000;
}

.dropdown div {
  padding: 6px 10px;
  cursor: pointer;
}

.dropdown div:hover {
  background: #f0f0f0;
}
</style>
</head>
  
<body>  
  <script src="/static/area_loader.js"></script>
  <button id="transportBtn" onclick="openTransportPopup()">üöö</button>
<!-- Transport Popup -->
<div id="transportPopupBR">
  <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á</h3>

  <div class="transport-type">
    <label>
      <input type="radio" name="transportType" value="trailer">
      üöõ ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏û‡πà‡∏ß‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
    </label>
    <label>
      <input type="radio" name="transportType" value="contract">
      üöö ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏´‡∏°‡∏≤‡∏Ñ‡∏±‡∏ô‡∏£‡∏ñ
    </label>
    <label>
      <input type="radio" name="transportType" value="person">
      üöô ‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞ (‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•)
    </label>
  </div>

  <hr>

  <div id="transportFormArea">
    <p class="hint">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏ô‡∏™‡πà‡∏á</p>
  </div>
    </div>

<div id="driverList"
     style="
       position: fixed;
       right: 10px;
       top: 60px;
       width: 280px;
       max-height: 80vh;
       overflow-y: auto;
       background: #fff;
       border-radius: 8px;
       padding: 10px;
       box-shadow: 0 2px 10px rgba(0,0,0,.15);
     ">
  <p>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</p>
</div>


<button id="importBtn" onclick="document.getElementById('importInput').click()">üì• Import CSV</button>
<input type="file" id="importInput" accept=".csv" style="display:none;" />

<!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏™‡∏µ‡πÅ‡∏î‡∏á -->
<button id="tempMarkerBtn">üî¥</button>

<!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß -->
<div id="tempMarkerForm">
  <input type="text" id="tempOLC" placeholder="OLC (‡πÄ‡∏ä‡πà‡∏ô 7P52VV6Q+J4)" />
  <button onclick="showTemporaryMarker(document.getElementById('tempOLC').value)">‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</button>
</div>

<style>
#tempMarkerBtn {
  position: fixed; bottom: 80px; right: 20px;
  width: 48px; height: 48px; border-radius: 24px;
  font-size: 28px; background: #ff4d4f; /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á */
  color: white; border: none; cursor: pointer;
  z-index: 9999; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

#tempMarkerForm {
  display: none;
  position: fixed; bottom: 140px; right: 20px;
  background: white; padding: 15px; border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3); width: 250px;
  z-index: 10000;
}

#tempMarkerForm input {
  width: 100%; padding: 8px; margin-bottom: 8px; box-sizing: border-box;
}
#tempMarkerForm button {
  width: 100%; padding: 8px; background: #ff4d4f; color: white; border: none; border-radius: 4px; cursor: pointer;
}
</style>

<script>
document.getElementById('tempMarkerBtn').onclick = function() {
  const form = document.getElementById('tempMarkerForm');
  form.style.display = (form.style.display === 'block') ? 'none' : 'block';
};
</script>

<style>
.olc-chip {
  background-color: #e0e0e0; /* ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ */
  border: none;
  border-radius: 8px;
  padding: 6px 12px;
  font-weight: bold;
  cursor: pointer;
  font-size: 14px;
  margin: 5px 0;
  transition: all 0.2s ease;
}

.olc-chip:hover {
  background-color: #d0d0d0;
}
.olc-chip:active {
  transform: scale(0.95);
}
</style>

<button id="exportBtn" onclick="window.location.href='/export'">üì§ Export CSV</button>
<input type="text" id="searchBox" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠ tag ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." />
<div id="mapid"></div>
<button id="floatBtn">+</button>

<div id="popupForm">
  <b id="formTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà</b><br>
  <input type="text" id="popupName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà" /><br>
  <input type="text" id="popupOLC" placeholder="OLC (‡πÄ‡∏ä‡πà‡∏ô 7P52VV6Q+J4)" /><br>
  <textarea id="popupAddress" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" rows="2"></textarea><br>
  <textarea id="popupDetail" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" rows="3"></textarea><br>
  <input type="text" id="popupTag" placeholder="tag ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ , )" /><br>
  <button id="savePopupBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  <button id="cancelPopupBtn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
</div>

<div id="toast"></div>
  
<script type="text/template" id="personFormTemplate">
  <div class="section">
    <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</h4>
    <input type="text" id="p_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö *">
    <input type="text" id="p_plate" placeholder="‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ">
    <select id="p_truck_type">
      <option value="">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ</option>
      <option>‡∏Å‡∏£‡∏∞‡∏ö‡∏∞‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</option>
      <option>‡∏Å‡∏£‡∏∞‡∏ö‡∏∞‡∏Ñ‡∏≠‡∏Å</option>
      <option>‡∏Å‡∏£‡∏∞‡∏ö‡∏∞‡∏ï‡∏π‡πâ</option>
      <option>‡∏Å‡∏£‡∏∞‡∏ö‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏£‡∏∞‡∏ö‡∏∞</option>
      <option>‡∏Å‡∏£‡∏∞‡∏ö‡∏∞‡πÇ‡∏£‡∏•‡∏ö‡∏≤‡∏£‡πå</option>
    </select>
    <input type="number" id="p_capacity" placeholder="‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÑ‡∏î‡πâ (‡∏ï‡∏±‡∏ô)">
  </div>

  <div class="section">
    <h4>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h4>
    <input type="text" id="p_phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ *">
    <input type="text" id="p_line" placeholder="Line ID / Link">
  </div>

  <div class="section">
    <h4>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡πÑ‡∏î‡πâ</h4>

     <div class="search-select">
    <input type="text" id="provinceInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">
    <div id="provinceList" class="dropdown"></div>
  </div>

  <div class="search-select">
    <input type="text" id="districtInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏≥‡πÄ‡∏†‡∏≠">
    <div id="districtList" class="dropdown"></div>
  </div>

  <div class="search-select">
    <input type="text" id="subdistrictInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏≥‡∏ö‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
    <div id="subdistrictList" class="dropdown"></div>
  </div>

  <small class="hint">
    ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏• ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
  </small>

    <button type="button" onclick="addArea()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</button>
    
    <hr>
   
    <div style="text-align:right;">
      <button onclick="saveTransport()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
    <ul id="areaList"></ul>
  </div>
</script>
  
<script>
  
  function showToast(message, duration = 3000) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.display = 'block';
    setTimeout(() => { toast.style.display = 'none'; }, duration);
  }

  var map = L.map('mapid').setView([13.7563, 100.5018], 12);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap &copy; CARTO',
    subdomains: 'abcd',
    maxZoom: 19
  }).addTo(map);

  var markers = [];
  var allMarkersData = [];
  var editingMarkerId = null;
  var tempMarker = null;

  async function loadMarkers() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    const res = await fetch('/markers');
    allMarkersData = await res.json();
    applyFilterAndShowMarkers();
  }

  function applyFilterAndShowMarkers() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    const searchText = document.getElementById('searchBox').value.trim().toLowerCase();
    const filtered = allMarkersData.filter(m => {
      const title = (m.title || '').toLowerCase();
      const tag = (m.tag || '').toLowerCase();
      return title.includes(searchText) || tag.includes(searchText);
    });

    filtered.forEach(m => {
      const popupContent = `
        <div>
          <b>${m.title}</b><br>
              
          <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á OLC ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ -->
          <button class="olc-chip" data-olc="${m.olc}" title="‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å OLC">
          ${m.olc || '-'}
          </button><br>

          <b>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</b> ${m.address || '-'}<br>
          <b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</b> ${m.detail || '-'}<br>
          <b>tag:</b> ${m.tag || '-'}<br><br>
          <button onclick="editMarker(${m.id})" style="margin-right:8px;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button onclick="deleteMarker(${m.id})" style="color: red;">‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ô‡∏µ‡πâ</button>
        </div>
      `;
      const marker = L.marker([m.lat, m.lon])
        .addTo(map)
        .bindTooltip(m.title || '', {
          permanent: true,
          direction: 'top',
          offset: [0, -10],
          className: 'marker-label'
        })
        .bindPopup(popupContent);
      markers.push(marker);
    });
  }


  // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å OLC ‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î
document.addEventListener("click", function(event) {
  if (event.target.classList.contains("olc-chip")) {
    const olc = event.target.getAttribute("data-olc");
    if (olc && olc !== '-') {
      navigator.clipboard.writeText(olc)
        .then(() => showToast(`‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å OLC: ${olc}`))
        .catch(() => showToast("‚ùå ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å OLC ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"));
    }
  }
});

  document.getElementById('searchBox').addEventListener('input', applyFilterAndShowMarkers);

  function showPopupForm() {
    document.getElementById('popupForm').style.display = 'block';
  }

  function hidePopupForm() {
    document.getElementById('popupForm').style.display = 'none';
    editingMarkerId = null;
    resetForm();
  }

  function resetForm() {
    document.getElementById('formTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà';
    document.getElementById('popupName').value = '';
    document.getElementById('popupOLC').value = '';
    document.getElementById('popupAddress').value = '';
    document.getElementById('popupDetail').value = '';
    document.getElementById('popupTag').value = '';
    document.getElementById('savePopupBtn').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
  }

  async function showTemporaryMarker(olc) {
    if (!olc) {
      showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OLC');
      return;
    }

    try {
      const res = await fetch("/decode_olc_temp", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ olc, province })
      });

      const data = await res.json();
      if (!res.ok) return showToast(data.error || "‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™ OLC ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

      const { lat, lng } = data;

      if (tempMarker) map.removeLayer(tempMarker);

      tempMarker = L.marker([lat, lng], {
        icon: L.icon({
          iconUrl: "https://maps.gstatic.com/intl/en_us/mapfiles/markers2/measle.png",
          iconSize: [12, 12],
          iconAnchor: [6, 6]
        })
      }).addTo(map).bindPopup(`<b>‡∏´‡∏°‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</b><br>OLC: ${olc}`).openPopup();

      map.setView([lat, lng], 18);

    } catch (err) {
      console.error(err);
      showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß");
    }
  }

function hidePopupForm() {
  document.getElementById('popupForm').style.display = 'none';
  editingMarkerId = null;
  resetForm();

  // ‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
  if (tempMarker) {
    map.removeLayer(tempMarker);
    tempMarker = null;
  }
}

  document.getElementById("floatBtn").onclick = function() {
    if (document.getElementById('popupForm').style.display === 'block') {
      hidePopupForm();
    } else {
      resetForm();
      showPopupForm();
    }
  };

  document.getElementById('cancelPopupBtn').onclick = hidePopupForm;

  document.getElementById('savePopupBtn').onclick = async function() {
    const title = document.getElementById('popupName').value.trim();
    const olc = document.getElementById('popupOLC').value.trim();
    const address = document.getElementById('popupAddress').value.trim();
    const detail = document.getElementById('popupDetail').value.trim();
    const tag = document.getElementById('popupTag').value.trim();

    if (!title) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà');
    if (!olc) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OLC (Plus Code)');

    const payload = { title, olc, address, detail, tag };
    let url = '/add_marker', method = 'POST';

    if (editingMarkerId !== null) {
      url = `/edit_marker/${editingMarkerId}`;
      method = 'PUT';
    }

    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const result = await res.json();
    if (res.ok) {
      showToast(editingMarkerId === null ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      hidePopupForm();
      loadMarkers();
    } else {
      showToast('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error);
    }
  };

  async function deleteMarker(id) {
    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

    const res = await fetch(`/delete_marker/${id}`, { method: 'DELETE' });
    const result = await res.json();

    if (res.ok) {
      showToast('‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      loadMarkers();
    } else {
      showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (result.error || ''));
    }
  }

  async function editMarker(id) {
    const res = await fetch(`/marker/${id}`);
    if (!res.ok) return showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏∏‡∏î');

    const data = await res.json();
    editingMarkerId = id;

    document.getElementById('formTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏∏‡∏î';
    document.getElementById('popupName').value = data.title || '';
    document.getElementById('popupOLC').value = data.olc || '';
    document.getElementById('popupAddress').value = data.address || '';
    document.getElementById('popupDetail').value = data.detail || '';
    document.getElementById('popupTag').value = data.tag || '';
    document.getElementById('savePopupBtn').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
    showPopupForm();
  }

  document.getElementById('importInput').addEventListener('change', async function () {
    const file = this.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    try {
      const res = await fetch('/import', {
        method: 'POST',
        body: formData
      });

      const result = await res.json();
      if (res.ok) {
        showToast('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        loadMarkers();
      } else {
        showToast('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (result.error || ''));
      }
    } catch (err) {
      showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå');
    }
  });

  loadMarkers();
</script>

  <script>
  let popup;
  let formArea;
</script>
  
<script>
document.addEventListener("DOMContentLoaded", () => {

  popup = document.getElementById("transportPopupBR");
  formArea = document.getElementById("transportFormArea");

  document
    .querySelectorAll('input[name="transportType"]')
    .forEach(radio => {
      radio.addEventListener("change", e => {
        if (e.target.value === "person") {
          formArea.innerHTML =
            document.getElementById("personFormTemplate").innerHTML;

          initAreaSearch();   // ‚≠ê ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
        } else {
          formArea.innerHTML =
            '<p class="hint">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ</p>';
        }
      });
    });

});
</script>

<script>
function openTransportPopup() {
  // ‡∏ñ‡πâ‡∏≤ popup ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‚Üí ‡∏õ‡∏¥‡∏î
  if (popup.style.display === "block") {
    closeTransportPopup();
    return;
  }

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î
  popup.style.display = "block";
  areas = [];
  document.getElementById("areaList").innerHTML = "";

  const checked = document.querySelector(
    'input[name="transportType"]:checked'
  );

  if (checked && checked.value === "person") {
    formArea.innerHTML =
      document.getElementById("personFormTemplate").innerHTML;

    initAreaSearch();
  } else {
    formArea.innerHTML =
      '<p class="hint">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏ô‡∏™‡πà‡∏á</p>';
  }
}
</script>

<script>
function closeTransportPopup() {
  popup.style.display = "none";

  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå state
  areas = [];
  document.getElementById("areaList").innerHTML = "";

  // üî• ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  clearHighlightDistricts();
}
</script>

<script>
function bindSearch(inputId, listId, items, onSelect) {
  const input = document.getElementById(inputId);
  const list = document.getElementById(listId);

  if (!input || !list || !items) return;

  input.oninput = () => {
    const q = input.value.trim();
    list.innerHTML = "";
    if (!q) return;

    items
      .filter(i => i.includes(q))
      .forEach(i => {
        const div = document.createElement("div");
        div.textContent = i;
        div.onclick = () => {
          input.value = i;
          list.innerHTML = "";
          onSelect(i);
        };
        list.appendChild(div);
      });
  };
}
</script>


<script>
function loadDrivers(latlng, province, district) {
  console.log("LOAD DRIVERS CALLED:", province, district);

  fetch(
    `/api/transport/personal/by-area?province=${encodeURIComponent(province)}&district=${encodeURIComponent(district)}`
  )
    .then(r => r.json())
    .then(drivers => {
      console.log("DRIVERS =", drivers);
      showDriverPopup(latlng, district, drivers);
    })
    .catch(err => {
      console.error(err);
      showDriverPopup(latlng, district, []);
    });
}


function initAreaSearch() {
  let selectedProvince = null;
  let selectedDistrict = null;

  bindSearch(
    "provinceInput",
    "provinceList",
    Object.keys(AREA_MAP),
    province => {
      selectedProvince = province;

      document.getElementById("districtInput").value = "";
      document.getElementById("subdistrictInput").value = "";

      // ‚úÖ ‡πÉ‡∏ä‡πâ AREA_MAP ‡∏ï‡∏£‡∏á ‡πÜ (‡πÄ‡∏õ‡πá‡∏ô array)
      bindSearch(
        "districtInput",
        "districtList",
        AREA_MAP[province],
        district => {
          selectedDistrict = district;
          document.getElementById("subdistrictInput").value = "";

          // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≥‡∏ö‡∏• ‚Üí ‡∏™‡πà‡∏á array ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
          bindSearch(
            "subdistrictInput",
            "subdistrictList",
            [],
            () => {}
          );
        }
      );
    }
  );
}

async function startApp() {
  await loadAreaData();   // ‚úÖ ‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  initAreaSearch();
}

startApp();

let areas = [];
    
function addArea() {
  const p = document.getElementById("provinceInput").value;
  const d = document.getElementById("districtInput").value;
  const s = document.getElementById("subdistrictInput").value || null;

  if (!p) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î");

  areas.push({
    province: normalizeProvinceName(p),
    district: d ? normalizeDistrictName(d) : null,
    subdistrict: s
  });



  const li = document.createElement("li");
  li.textContent =
    p +
    (d ? " / " + d : " (‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)") +
    (s ? " / " + s : "");

  document.getElementById("areaList").appendChild(li);

  document.getElementById("districtInput").value = "";
  document.getElementById("subdistrictInput").value = "";

  // ‚≠ê ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡πÅ‡∏ö‡∏ö‡∏™‡∏∞‡∏™‡∏°
  if (d) {
    highlightedDistricts.add(normalizeDistrictName(d));
    highlightDistricts();
  }
}


async function saveTransport() {
  const type = document.querySelector(
    'input[name="transportType"]:checked'
  )?.value;

  if (type !== "person") {
    alert("‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞ (‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•)");
    return;
  }

   const payload = {
    transport_type: "person",
    owner_name: document.getElementById("p_name")?.value.trim(),
    license_plate: document.getElementById("p_plate")?.value.trim(),
    vehicle_type: document.getElementById("p_truck_type")?.value,
    capacity_ton: document.getElementById("p_capacity")?.value,
    phone: document.getElementById("p_phone")?.value.trim(),
    line: document.getElementById("p_line")?.value.trim(),
    areas: areas
  };

  if (!payload.owner_name || !payload.phone) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö ‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£");
    return;
  }
 
  if (areas.length === 0) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà");
    return;
  }

  try {
    const res = await fetch("/save_transport_personal", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (!res.ok) {
      alert(data.error || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      return;
    }

    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    closeTransportPopup();
    areas = [];
    document.getElementById("areaList").innerHTML = "";

  } catch (err) {
    console.error(err);
    alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
  }
}


</script>

<!-- ‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏£‡∏Å -->
<script>
fetch("/static/thailand_district.geojson")
  .then(res => res.json())
  .then(data => {

    districtLayer = L.geoJSON(data, {
      style: {
        color: "#555",
        weight: 1,
        fillOpacity: 0
      },
      onEachFeature: (feature, layer) => {

        const province = normalizeProvinceName(
        feature.properties.NL_NAME_1
        );   // ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
        const district = feature.properties.NL_NAME_2; // ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠

        // hover ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
        layer.bindTooltip(district, { sticky: true });

        // üî• double click ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
        layer.on("dblclick", e => {
          const province = normalizeProvinceName(
          feature.properties.NL_NAME_1
          );

          const district = normalizeDistrictName(
          feature.properties.NL_NAME_2
          );

          loadDrivers(e.latlng, province, district);
          });
      }
    }).addTo(map);
  });

// ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å ‚ùó ‡∏õ‡∏¥‡∏î zoom ‡∏à‡∏≤‡∏Å double click
map.doubleClickZoom.disable();
</script>


<!-- pop up ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö -->
<script>
function showDriverPopup(latlng, district, drivers) {
  let html = `<h4>üöö ‡∏£‡∏ñ‡πÉ‡∏ô‡∏≠‡∏≥‡πÄ‡∏†‡∏≠${district}</h4>`;

  if (!drivers || drivers.length === 0) {
    html += `<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏ñ‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ</p>`;
  } else {
    drivers.forEach(d => {
      html += `
        <div style="margin-bottom:8px;">
          <b>${d.name}</b><br>
          ${d.vehicle_type} (${d.capacity} ‡∏ï‡∏±‡∏ô)<br>
          üìû ${d.phone}
        </div>
      `;
    });
  }

  L.popup({ maxWidth: 300 })
    .setLatLng(latlng)
    .setContent(html)
    .openOn(map);
}
</script>

<script>
let highlightedDistricts = new Set();
</script>

  
<script>
function normalizeDistrictName(name) {
  if (!name) return "";
  return name
    .replace("‡∏≠‡∏≥‡πÄ‡∏†‡∏≠", "")
    .replace("‡πÄ‡∏Ç‡∏ï", "")
    .replace("‡∏≠.", "")
    .trim();
}

function highlightDistricts() {
  if (!districtLayer) return;

  districtLayer.eachLayer(layer => {
    const geoNameRaw =
      layer.feature.properties?.NL_NAME_2 ||
      layer.feature.properties?.NAME_2 ||
      "";

    const geoName = normalizeDistrictName(geoNameRaw);

    if (highlightedDistricts.has(geoName)) {
      layer.setStyle({
        color: "#ff6600",
        weight: 3,
        fillOpacity: 0.35
      });
    } else {
      layer.setStyle({
        color: "#999",
        weight: 1,
        fillOpacity: 0.05
      });
    }
  });
}

function clearHighlightDistricts() {
  highlightedDistricts.clear();
  highlightDistricts();
}

// expose
window.highlightDistricts = highlightDistricts;
</script>

<script>
function normalizeProvinceName(name) {
  if (!name) return "";
  return name
    .replace("‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î", "")
    .trim();
}
</script>



</body>
</html>
